<div class="flex-1 max-w-4xl mx-auto bg-white shadow-md p-6 rounded-lg mt-5">
  <h2 class="text-2xl font-bold text-center mb-6">
    {% if mode_modification %}
      Modification de rendez-vous
    {% else %}
      Prise de rendez-vous
    {% endif %}
  </h2>
  
  {% if mode_modification %}
    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
      <p class="text-center text-blue-800 font-medium">
        Vous modifiez votre rendez-vous. Choisissez une nouvelle date et heure pour le remplacer.
      </p>
    </div>
  {% endif %}

  <!-- Étape 1 : Choix de l'exercice -->
  <form method="get" action="" class="mb-6">
    <div class="mb-4">
      <label for="exercice" class="block text-sm font-medium text-gray-700 mb-2">Choisissez votre exercice :</label>
      <select name="exercice" id="exercice" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" onchange="this.form.submit()">
        <option value="">-- Sélectionnez un exercice --</option>
        {% for exercice in exercices %}
          <option value="{{ exercice.id }}" {% if exercice_selectionne and exercice_selectionne.id == exercice.id %}selected{% endif %}>
            {{ exercice.nom }} - {{ exercice.duree }} - {{ exercice.tarif }}€
          </option>
        {% endfor %}
      </select>
    </div>
    {% if exercice_selectionne %}
      <input type="hidden" name="mois" value="{{ month }}">
      <input type="hidden" name="annee" value="{{ year }}">
    {% endif %}
  </form>

  {% if exercice_selectionne %}
    <!-- Étape 2 : Sélection de la date -->
    <div class="flex justify-between items-center mb-6">
      <a href="?exercice={{ exercice_selectionne.id }}&mois={{ mois_precedent.mois }}&annee={{ mois_precedent.annee }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
        {{ mois_precedent.nom }}
      </a>
      <span class="text-lg font-semibold text-gray-800">{{ mois_actuel }}</span>
      <a href="?exercice={{ exercice_selectionne.id }}&mois={{ mois_suivant.mois }}&annee={{ mois_suivant.annee }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm">
        {{ mois_suivant.nom }}
      </a>
    </div>

    <div class="grid grid-cols-7 gap-2 text-center mb-2">
      {% for label in jours_semaine %}
        <div class="font-semibold text-gray-700">{{ label }}</div>
      {% endfor %}
    </div>

    <div class="grid grid-cols-7 gap-2 text-center">
      {% for _ in range_precalé %}
        <div></div>
      {% endfor %}

      {% for jour in jours_du_mois %}
        {% if jour.disable %}
          <button class="py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded cursor-not-allowed" disabled>{{ jour.numero }}</button>
        {% else %}
          <a href="?exercice={{ exercice_selectionne.id }}&mois={{ month }}&annee={{ year }}&date={{ jour.date|date:'Y-m-d' }}" class="block py-2 border border-gray-300 bg-white text-gray-800 rounded hover:bg-gray-100">
            {{ jour.numero }}
          </a>
        {% endif %}
      {% endfor %}
    </div>

    {% if date_selectionnee %}
      <div class="mt-8">
        <p class="text-center font-medium text-gray-700 mb-2">Cliquez pour ajouter/retirer un créneau</p>
        <div class="grid grid-cols-4 gap-2">
          {% for h in heures_disponibles %}
            {% if date_selectionnee == today|stringformat:"Y-m-d" and h < heure_limite %}
              <button class="py-2 border border-gray-200 bg-gray-100 text-gray-400 rounded cursor-not-allowed" disabled>{{ h }}</button>
            {% elif h in creneaux_reserves %}
              <button class="py-2 border border-gray-300 bg-gray-200 text-gray-600 rounded cursor-not-allowed font-medium" disabled>
                {{ h }}
                <div class="text-xs text-gray-500 mt-1">Réservé</div>
              </button>
            {% else %}
              <button 
                id="creneau-{{ h }}"
                onclick="toggleCreneau('{{ exercice_selectionne.id }}', '{{ date_selectionnee }}', '{{ h }}')"
                class="py-2 border border-gray-300 bg-white text-black rounded hover:bg-gray-100 cursor-pointer transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2">
                {{ h }}
              </button>
            {% endif %}
          {% endfor %}
        </div>
      </div>
    {% endif %}

    <!-- Notifications -->
    <div id="notification" class="fixed top-4 right-4 z-50 hidden">
      <div class="bg-white border-l-4 p-4 shadow-lg rounded-r-lg max-w-sm">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg id="notification-icon" class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
          </div>
          <div class="ml-3">
            <p id="notification-message" class="text-sm font-medium text-gray-900"></p>
          </div>
          <div class="ml-auto pl-3">
            <button onclick="hideNotification()" class="text-gray-400 hover:text-gray-600">
              <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Étape 3 : Récapitulatif des créneaux sélectionnés -->
    <div id="recapitulatif" class="mt-8 hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Récapitulatif de votre réservation</h3>
      <div id="creneaux-list" class="space-y-2 mb-4">
        <!-- Les créneaux seront ajoutés ici dynamiquement -->
      </div>
      <div class="border-t pt-4">
        <p class="text-lg font-bold text-gray-800">Total : <span id="total-tarif" class="text-black">0€</span></p>
      </div>
      <div class="mt-6 flex gap-4">
        <button 
          onclick="validerReservation()"
          class="flex-1 bg-green-600 text-white py-3 font-semibold rounded transition hover:bg-green-700">
          Valider la réservation
        </button>
        <button 
          onclick="viderReservation()"
          class="px-6 py-3 bg-red-600 text-white font-semibold rounded transition hover:bg-red-700">
          Vider
        </button>
      </div>
    </div>
  {% endif %}
</div>

<script>
let creneauxSelectionnes = [];
let creneauxIds = {}; // Pour stocker les IDs des créneaux ajoutés

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const messageEl = document.getElementById('notification-message');
    const icon = document.getElementById('notification-icon');
    
    messageEl.textContent = message;
    
    // Changer la couleur selon le type
    if (type === 'success') {
        notification.querySelector('.border-l-4').classList.remove('border-red-500', 'border-yellow-500');
        notification.querySelector('.border-l-4').classList.add('border-green-500');
        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>';
    } else if (type === 'error') {
        notification.querySelector('.border-l-4').classList.remove('border-green-500', 'border-yellow-500');
        notification.querySelector('.border-l-4').classList.add('border-red-500');
        icon.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm4.707-4.707a1 1 0 00-1.414-1.414L10 12.586l-1.293-1.293a1 1 0 00-1.414 1.414L8.586 14l-1.293 1.293a1 1 0 101.414 1.414L10 15.414l1.293 1.293a1 1 0 001.414-1.414L11.414 14l1.293-1.293a1 1 0 000-1.414z" clip-rule="evenodd"></path>';
    } else if (type === 'warning') {
        notification.querySelector('.border-l-4').classList.remove('border-green-500', 'border-red-500');
        notification.querySelector('.border-l-4').classList.add('border-yellow-500');
        icon.innerHTML = '<path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>';
    }
    
    notification.classList.remove('hidden');
    
    // Auto-hide après 4 secondes
    setTimeout(() => {
        hideNotification();
    }, 4000);
}

function hideNotification() {
    document.getElementById('notification').classList.add('hidden');
}

function toggleCreneau(exerciceId, date, heure) {
    const creneauKey = `${date}-${heure}`;
    const button = document.getElementById(`creneau-${heure}`);
    
    // Vérifier si le créneau est déjà sélectionné
    if (creneauxIds[creneauKey]) {
        // Supprimer le créneau
        supprimerCreneau(creneauxIds[creneauKey], exerciceId, date, heure);
    } else {
        // Ajouter le créneau
        ajouterCreneau(exerciceId, date, heure);
    }
}

function ajouterCreneau(exerciceId, date, heure) {
    fetch('{% url "coach:ajouter_creneau" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            exercice_id: exerciceId,
            date: date,
            heure: heure
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Ajouter le créneau à la liste
            const creneau = {
                id: data.rdv_id || Date.now(), // Utiliser l'ID retourné par le serveur
                exercice: '{{ exercice_selectionne.nom }}',
                date: date,
                heure: heure,
                tarif: {{ exercice_selectionne.tarif }}
            };
            creneauxSelectionnes.push(creneau);
            
            // Stocker l'ID du créneau
            const creneauKey = `${date}-${heure}`;
            creneauxIds[creneauKey] = creneau.id;
            
            // Mettre à jour l'apparence du bouton
            const button = document.getElementById(`creneau-${heure}`);
            button.classList.remove('bg-white', 'text-black', 'hover:bg-gray-100');
            button.classList.add('bg-black', 'text-white', 'border-black');
            
            afficherRecapitulatif();
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de l\'ajout du créneau', 'error');
    });
}

function supprimerCreneau(rdvId, exerciceId, date, heure) {
    fetch('{% url "coach:supprimer_creneau" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            rdv_id: rdvId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Retirer le créneau de la liste
            creneauxSelectionnes = creneauxSelectionnes.filter(c => c.id !== rdvId);
            
            // Retirer l'ID du créneau
            const creneauKey = `${date}-${heure}`;
            delete creneauxIds[creneauKey];
            
            // Mettre à jour l'apparence du bouton
            const button = document.getElementById(`creneau-${heure}`);
            button.classList.remove('bg-black', 'text-white', 'border-black');
            button.classList.add('bg-white', 'text-black', 'hover:bg-gray-100');
            
            afficherRecapitulatif();
            showNotification(data.message, 'success');
        } else {
            showNotification(data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la suppression du créneau', 'error');
    });
}

function afficherRecapitulatif() {
    const recapitulatif = document.getElementById('recapitulatif');
    const creneauxList = document.getElementById('creneaux-list');
    const totalTarif = document.getElementById('total-tarif');
    
    if (creneauxSelectionnes.length > 0) {
        recapitulatif.classList.remove('hidden');
        
        creneauxList.innerHTML = '';
        let total = 0;
        
        creneauxSelectionnes.forEach(creneau => {
            const creneauElement = document.createElement('div');
            creneauElement.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
            creneauElement.innerHTML = `
                <div>
                    <span class="font-medium">${creneau.exercice}</span>
                    <span class="text-gray-600 ml-2">${creneau.date} à ${creneau.heure}h00</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-semibold text-black">${creneau.tarif}€</span>
                    <button onclick="supprimerCreneau(${creneau.id}, '{{ exercice_selectionne.id }}', '${creneau.date}', ${creneau.heure})" class="text-red-600 hover:text-red-800">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            `;
            creneauxList.appendChild(creneauElement);
            total += creneau.tarif;
        });
        
        totalTarif.textContent = total + '€';
    } else {
        recapitulatif.classList.add('hidden');
    }
}

function validerReservation() {
    if (creneauxSelectionnes.length === 0) {
        showNotification('Aucun créneau sélectionné', 'warning');
        return;
    }
    
    fetch('{% url "coach:valider_reservation" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        if (response.ok) {
            window.location.href = '{% url "coach:votre_rendez_vous" %}';
        } else {
            showNotification('Erreur lors de la validation', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la validation', 'error');
    });
}

function viderReservation() {
    // Supprimer tous les créneaux du serveur
    const promises = creneauxSelectionnes.map(creneau => {
        const creneauKey = `${creneau.date}-${creneau.heure}`;
        return supprimerCreneau(creneau.id, '{{ exercice_selectionne.id }}', creneau.date, creneau.heure);
    });
    
    Promise.all(promises).then(() => {
        creneauxSelectionnes = [];
        creneauxIds = {};
        afficherRecapitulatif();
        showNotification('Réservation vidée', 'success');
    });
}

// Ajouter le token CSRF
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        const token = document.createElement('input');
        token.type = 'hidden';
        token.name = 'csrfmiddlewaretoken';
        token.value = '{{ csrf_token }}';
        document.body.appendChild(token);
    }
});
</script>
