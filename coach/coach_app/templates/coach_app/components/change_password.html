<h2 class="text-2xl font-bold text-center text-gray-800 mb-4">
  Changer votre mot de passe
</h2>

<div class="text-center text-gray-700 text-lg mb-6">
  <p>Utilisateur : <span class="font-semibold text-blue-600">{{ request.user.username }}</span></p>
</div>

<form method="post" action="{% url 'change_password' %}" class="space-y-6" autocomplete="off" id="changePasswordForm">
  {% csrf_token %}
  
  <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Mot de passe actuel
    </label>
    <div class="relative">
      <input name="current_password" type="password" autocomplete="current-password" id="currentPassword"
             class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white"
             required>
      <button type="button" onclick="togglePassword('currentPassword')" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
        <svg id="eyeCurrent" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <svg id="eye-slashCurrent" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
        </svg>
      </button>
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Nouveau mot de passe
    </label>
    <div class="relative">
      <input name="new_password1" type="password" autocomplete="new-password" id="newPassword1"
             class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white"
             required>
      <button type="button" onclick="togglePassword('newPassword1')" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
        <svg id="eye1" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <svg id="eye-slash1" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
        </svg>
      </button>
    </div>
    
    <!-- Règles de mot de passe -->
    <div class="mt-3 space-y-2">
      <div class="text-xs text-gray-600 font-medium">Le mot de passe doit contenir :</div>
      <div id="passwordRules" class="space-y-1">
        <div id="rule-length" class="flex items-center text-xs">
          <span class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 flex items-center justify-center">×</span>
          <span class="text-gray-500">Au moins 8 caractères</span>
        </div>
        <div id="rule-common" class="flex items-center text-xs">
          <span class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 flex items-center justify-center">×</span>
          <span class="text-gray-500">Pas un mot de passe commun</span>
        </div>
        <div id="rule-numeric" class="flex items-center text-xs">
          <span class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 flex items-center justify-center">×</span>
          <span class="text-gray-500">Pas entièrement numérique</span>
        </div>
        <div id="rule-letters" class="flex items-center text-xs">
          <span class="w-4 h-4 mr-2 rounded-full border-2 border-gray-300 flex items-center justify-center">×</span>
          <span class="text-gray-500">Lettres et chiffres</span>
        </div>
      </div>
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium text-gray-700 mb-2">
      Confirmer le nouveau mot de passe
    </label>
    <div class="relative">
      <input name="new_password2" type="password" autocomplete="new-password" id="newPassword2"
             class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-xl focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all duration-200 bg-gray-50 focus:bg-white"
             required>
      <button type="button" onclick="togglePassword('newPassword2')" 
              class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600">
        <svg id="eye2" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
        </svg>
        <svg id="eye-slash2" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.878 9.878L3 3m6.878 6.878L21 21"></path>
        </svg>
      </button>
    </div>
    <div id="passwordMatch" class="mt-2 text-sm hidden"></div>
  </div>

  <button type="submit" id="submitBtn" class="w-full bg-gray-400 text-white py-3 px-4 rounded-xl font-medium transition-all duration-200 shadow-lg cursor-not-allowed" disabled>
    Changer le mot de passe
  </button>
</form>

<script>
  function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    let eye, eyeSlash;
    
    if (fieldId === 'currentPassword') {
      eye = document.getElementById('eyeCurrent');
      eyeSlash = document.getElementById('eye-slashCurrent');
    } else {
      const num = fieldId.slice(-1);
      eye = document.getElementById('eye' + num);
      eyeSlash = document.getElementById('eye-slash' + num);
    }
    
    if (field.type === 'password') {
      field.type = 'text';
      eye.classList.add('hidden');
      eyeSlash.classList.remove('hidden');
    } else {
      field.type = 'password';
      eye.classList.remove('hidden');
      eyeSlash.classList.add('hidden');
    }
  }

  // Mots de passe communs à éviter
  const commonPasswords = [
    'password', '123456', '12345678', 'qwerty', 'abc123', 'password123',
    'admin', 'letmein', 'welcome', 'monkey', 'dragon', 'master', 'hello'
  ];

  // Validation des règles de mot de passe
  function validatePassword(password) {
    const rules = {
      length: password.length >= 8,
      common: !commonPasswords.includes(password.toLowerCase()),
      numeric: !/^\d+$/.test(password),
      letters: /[a-zA-Z]/.test(password) && /[0-9]/.test(password)
    };

    // Mise à jour visuelle des règles
    updateRuleDisplay('rule-length', rules.length);
    updateRuleDisplay('rule-common', rules.common);
    updateRuleDisplay('rule-numeric', rules.numeric);
    updateRuleDisplay('rule-letters', rules.letters);

    return Object.values(rules).every(rule => rule);
  }

  function updateRuleDisplay(ruleId, isValid) {
    const ruleElement = document.getElementById(ruleId);
    const icon = ruleElement.querySelector('span');
    const text = ruleElement.querySelector('span:last-child');
    
    if (isValid) {
      icon.className = 'w-4 h-4 mr-2 rounded-full bg-green-500 flex items-center justify-center text-white text-xs';
      icon.textContent = '✓';
      text.className = 'text-green-600';
    } else {
      icon.className = 'w-4 h-4 mr-2 rounded-full border-2 border-gray-300 flex items-center justify-center text-gray-400 text-xs';
      icon.textContent = '×';
      text.className = 'text-gray-500';
    }
  }

  // Validation en temps réel du nouveau mot de passe
  document.getElementById('newPassword1').addEventListener('input', function() {
    const password = this.value;
    const isValid = validatePassword(password);
    
    // Mise à jour de la validation de correspondance
    const password2 = document.getElementById('newPassword2').value;
    if (password2.length > 0) {
      validatePasswordMatch(password, password2);
    }
    
    updateSubmitButton();
  });

  // Validation en temps réel de la correspondance
  document.getElementById('newPassword2').addEventListener('input', function() {
    const password1 = document.getElementById('newPassword1').value;
    const password2 = this.value;
    validatePasswordMatch(password1, password2);
    updateSubmitButton();
  });

  function validatePasswordMatch(password1, password2) {
    const matchDiv = document.getElementById('passwordMatch');
    
    if (password2.length > 0) {
      if (password1 === password2) {
        matchDiv.textContent = '✓ Les mots de passe correspondent';
        matchDiv.className = 'mt-2 text-sm text-green-600';
        matchDiv.classList.remove('hidden');
      } else {
        matchDiv.textContent = '✗ Les mots de passe ne correspondent pas';
        matchDiv.className = 'mt-2 text-sm text-red-600';
        matchDiv.classList.remove('hidden');
      }
    } else {
      matchDiv.classList.add('hidden');
    }
  }

  function updateSubmitButton() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword1 = document.getElementById('newPassword1').value;
    const newPassword2 = document.getElementById('newPassword2').value;
    const submitBtn = document.getElementById('submitBtn');
    
    const currentPasswordFilled = currentPassword.length > 0;
    const newPasswordValid = validatePassword(newPassword1);
    const passwordsMatch = newPassword1 === newPassword2 && newPassword2.length > 0;
    
    if (currentPasswordFilled && newPasswordValid && passwordsMatch) {
      submitBtn.className = 'w-full bg-slate-900 hover:bg-slate-800 text-white py-3 px-4 rounded-xl font-medium transition-all duration-200 shadow-lg hover:shadow-xl';
      submitBtn.disabled = false;
      submitBtn.classList.remove('cursor-not-allowed');
    } else {
      submitBtn.className = 'w-full bg-gray-400 text-white py-3 px-4 rounded-xl font-medium transition-all duration-200 shadow-lg cursor-not-allowed';
      submitBtn.disabled = true;
    }
  }

  // Validation du mot de passe actuel
  document.getElementById('currentPassword').addEventListener('input', updateSubmitButton);
</script> 